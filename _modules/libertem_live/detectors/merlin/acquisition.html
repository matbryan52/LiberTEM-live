
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>libertem_live.detectors.merlin.acquisition &#8212; LiberTEM-live 0.2.0.dev0 documentation</title>
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script src="../../../../_static/jquery.js"></script>
    <script src="../../../../_static/underscore.js"></script>
    <script src="../../../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="shortcut icon" href="../../../../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for libertem_live.detectors.merlin.acquisition</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">contextmanager</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">libertem.common</span> <span class="kn">import</span> <span class="n">Shape</span><span class="p">,</span> <span class="n">Slice</span>
<span class="kn">from</span> <span class="nn">libertem.io.dataset.base</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">DataTile</span><span class="p">,</span> <span class="n">DataSetMeta</span><span class="p">,</span> <span class="n">BasePartition</span><span class="p">,</span> <span class="n">Partition</span><span class="p">,</span> <span class="n">DataSet</span><span class="p">,</span>
<span class="p">)</span>

<span class="kn">from</span> <span class="nn">libertem_live.detectors.base.acquisition</span> <span class="kn">import</span> <span class="n">AcquisitionMixin</span>
<span class="kn">from</span> <span class="nn">.data</span> <span class="kn">import</span> <span class="n">MerlinDataSource</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="MerlinAcquisition"><a class="viewcode-back" href="../../../../reference.html#libertem_live.detectors.merlin.MerlinAcquisition">[docs]</a><span class="k">class</span> <span class="nc">MerlinAcquisition</span><span class="p">(</span><span class="n">AcquisitionMixin</span><span class="p">,</span> <span class="n">DataSet</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Acquisition from a Quantum Detectors Merlin camera</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>

<span class="sd">    trigger : function()</span>
<span class="sd">        See :meth:`~libertem_live.api.LiveContext.prepare_acquisition`</span>
<span class="sd">        and :ref:`trigger` for details!</span>
<span class="sd">    scan_size : tuple(int)</span>
<span class="sd">    host : str</span>
<span class="sd">        Hostname of the Merlin data server, default &#39;127.0.0.1&#39;</span>
<span class="sd">    port : int</span>
<span class="sd">        Data port of the Merlin data server, default 6342</span>
<span class="sd">    drain : bool</span>
<span class="sd">        Drain the socket before triggering. Disable this when using internal</span>
<span class="sd">        start trigger!</span>
<span class="sd">    frames_per_partition : int</span>
<span class="sd">        Number of frames to process before performing a merge operation. Decreasing this number</span>
<span class="sd">        increases the update rate, but can decrease performance.</span>
<span class="sd">    pool_size : int</span>
<span class="sd">        Number of decoding threads. Defaults to 2</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">trigger</span><span class="p">,</span>
        <span class="n">scan_size</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="mi">6342</span><span class="p">,</span>
        <span class="n">drain</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">frames_per_partition</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
        <span class="n">pool_size</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># This will also call the DataSet constructor, additional arguments</span>
        <span class="c1"># could be passed -- currently not necessary</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">trigger</span><span class="o">=</span><span class="n">trigger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">MerlinDataSource</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">pool_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_drain</span> <span class="o">=</span> <span class="n">drain</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_size</span> <span class="o">=</span> <span class="n">scan_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_frames_per_partition</span> <span class="o">=</span> <span class="n">frames_per_partition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>

<div class="viewcode-block" id="MerlinAcquisition.initialize"><a class="viewcode-back" href="../../../../reference.html#libertem_live.detectors.merlin.MerlinAcquisition.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">executor</span><span class="p">):</span>
        <span class="c1"># FIXME: possibly need to have an &quot;acquisition plan&quot; object</span>
        <span class="c1"># so we know all relevant parameters beforehand</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">uint8</span>  <span class="c1"># FIXME: don&#39;t know the dtype yet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span> <span class="o">=</span> <span class="n">DataSetMeta</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">Shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scan_size</span> <span class="o">+</span> <span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span> <span class="n">sig_dims</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
            <span class="n">raw_dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">dtype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">raw_dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">raw_dtype</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">meta</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_meta</span>

<div class="viewcode-block" id="MerlinAcquisition.acquire"><a class="viewcode-back" href="../../../../reference.html#libertem_live.detectors.merlin.MerlinAcquisition.acquire">[docs]</a>    <span class="nd">@contextmanager</span>
    <span class="k">def</span> <span class="nf">acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drain</span><span class="p">:</span>
                <span class="n">drained_bytes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">drained_bytes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;drained </span><span class="si">{</span><span class="n">drained_bytes</span><span class="si">}</span><span class="s2"> bytes of garbage&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trigger</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">read_headers</span><span class="p">(</span><span class="n">cancel_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span><span class="p">)</span>
            <span class="k">yield</span></div>

<div class="viewcode-block" id="MerlinAcquisition.check_valid"><a class="viewcode-back" href="../../../../reference.html#libertem_live.detectors.merlin.MerlinAcquisition.check_valid">[docs]</a>    <span class="k">def</span> <span class="nf">check_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>

    <span class="c1"># def wait_for_acquisition(self):</span>
    <span class="c1">#     logger.info(&quot;waiting for acquisition header&quot;)</span>
    <span class="c1">#     header = self.source.socket.get_acquisition_header()</span>

    <span class="c1">#     bit_depth = int(header[&#39;Counter Depth (number)&#39;])</span>
    <span class="c1">#     if bit_depth in (1, 6):</span>
    <span class="c1">#         dtype = np.uint8</span>
    <span class="c1">#     elif bit_depth in (12,):</span>
    <span class="c1">#         dtype = np.uint16</span>
    <span class="c1">#     else:  # 24 bit?</span>
    <span class="c1">#         dtype = np.uint32</span>
    <span class="c1">#     self._meta = DataSetMeta(</span>
    <span class="c1">#         shape=Shape(self._scan_size + (256, 256), sig_dims=2),</span>
    <span class="c1">#         raw_dtype=dtype,</span>
    <span class="c1">#         dtype=dtype,</span>
    <span class="c1">#     )</span>
    <span class="c1">#     return header</span>

<div class="viewcode-block" id="MerlinAcquisition.get_partitions"><a class="viewcode-back" href="../../../../reference.html#libertem_live.detectors.merlin.MerlinAcquisition.get_partitions">[docs]</a>    <span class="k">def</span> <span class="nf">get_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># FIXME: only works for inline executor or similar, as we pass a</span>
        <span class="c1"># TCP connection to each partition, which cannot be serialized</span>
        <span class="n">num_frames</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scan_size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">uint64</span><span class="p">)</span>
        <span class="n">num_partitions</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_frames</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">_frames_per_partition</span><span class="p">)</span>

        <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">get_acquisition_header</span><span class="p">()</span>

        <span class="n">slices</span> <span class="o">=</span> <span class="n">BasePartition</span><span class="o">.</span><span class="n">make_slices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">num_partitions</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">part_slice</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span> <span class="ow">in</span> <span class="n">slices</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">MerlinLivePartition</span><span class="p">(</span>
                <span class="n">start_idx</span><span class="o">=</span><span class="n">start</span><span class="p">,</span>
                <span class="n">end_idx</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span>
                <span class="n">meta</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="p">,</span>
                <span class="n">partition_slice</span><span class="o">=</span><span class="n">part_slice</span><span class="p">,</span>
                <span class="n">data_source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                <span class="n">acq_header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span>
            <span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">MerlinLivePartition</span><span class="p">(</span><span class="n">Partition</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">,</span> <span class="n">partition_slice</span><span class="p">,</span>
        <span class="n">data_source</span><span class="p">,</span> <span class="n">meta</span><span class="p">,</span> <span class="n">acq_header</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">meta</span><span class="o">=</span><span class="n">meta</span><span class="p">,</span> <span class="n">partition_slice</span><span class="o">=</span><span class="n">partition_slice</span><span class="p">,</span> <span class="n">io_backend</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_idx</span> <span class="o">=</span> <span class="n">start_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_end_idx</span> <span class="o">=</span> <span class="n">end_idx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acq_header</span> <span class="o">=</span> <span class="n">acq_header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span> <span class="o">=</span> <span class="n">data_source</span>

    <span class="k">def</span> <span class="nf">shape_for_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roi</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice</span><span class="o">.</span><span class="n">adjust_for_roi</span><span class="p">(</span><span class="n">roi</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">shape</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice</span><span class="o">.</span><span class="n">shape</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">dtype</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">raw_dtype</span>

    <span class="k">def</span> <span class="nf">set_corrections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corrections</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_corrections</span> <span class="o">=</span> <span class="n">corrections</span>

    <span class="k">def</span> <span class="nf">need_decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">read_dtype</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">corrections</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>  <span class="c1"># FIXME: we just do this to get a large tile size</span>

    <span class="k">def</span> <span class="nf">adjust_tileshape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tileshape</span><span class="p">,</span> <span class="n">roi</span><span class="p">):</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_idx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_idx</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
        <span class="c1"># return Shape((self._end_idx - self._start_idx, 256, 256), sig_dims=2)</span>

    <span class="k">def</span> <span class="nf">get_max_io_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># return 12*256*256*8</span>
        <span class="k">return</span> <span class="mi">24</span><span class="o">*</span><span class="mi">256</span><span class="o">*</span><span class="mi">256</span><span class="o">*</span><span class="mi">8</span>

    <span class="k">def</span> <span class="nf">get_base_shape</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">roi</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_tiles_fullframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiling_scheme</span><span class="p">,</span> <span class="n">dest_dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># assert len(tiling_scheme) == 1</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;reading up to frame idx </span><span class="si">%d</span><span class="s2"> for this partition&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_idx</span><span class="p">)</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data_source</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_impl</span><span class="p">(</span>
            <span class="n">read_upto_frame</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_end_idx</span><span class="p">,</span>
            <span class="c1"># chunk_size=11,</span>
            <span class="n">chunk_size</span><span class="o">=</span><span class="n">tiling_scheme</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">to_read</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_end_idx</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_idx</span>
        <span class="k">with</span> <span class="n">pool</span><span class="p">:</span>
            <span class="k">while</span> <span class="n">to_read</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># logger.debug(</span>
                <span class="c1">#     &quot;LivePartition.get_tiles: to_read=%d, start_idx=%d end_idx=%d&quot;,</span>
                <span class="c1">#     to_read, self._start_idx, self._end_idx,</span>
                <span class="c1"># )</span>
                <span class="k">with</span> <span class="n">pool</span><span class="o">.</span><span class="n">get_result</span><span class="p">()</span> <span class="k">as</span> <span class="n">res_wrapped</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">res_wrapped</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># ReaderThread was stopped</span>
                        <span class="k">return</span>
                    <span class="n">frames_in_tile</span> <span class="o">=</span> <span class="n">res_wrapped</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">res_wrapped</span><span class="o">.</span><span class="n">start</span>
                    <span class="n">tile_shape</span> <span class="o">=</span> <span class="n">Shape</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">frames_in_tile</span><span class="p">,)</span> <span class="o">+</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">tiling_scheme</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span>
                        <span class="n">sig_dims</span><span class="o">=</span><span class="mi">2</span>
                    <span class="p">)</span>
                    <span class="n">tile_slice</span> <span class="o">=</span> <span class="n">Slice</span><span class="p">(</span>
                        <span class="n">origin</span><span class="o">=</span><span class="p">(</span><span class="n">res_wrapped</span><span class="o">.</span><span class="n">start</span><span class="p">,)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                        <span class="n">shape</span><span class="o">=</span><span class="n">tile_shape</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">yield</span> <span class="n">DataTile</span><span class="p">(</span>
                        <span class="n">res_wrapped</span><span class="o">.</span><span class="n">buf</span><span class="p">,</span>
                        <span class="n">tile_slice</span><span class="o">=</span><span class="n">tile_slice</span><span class="p">,</span>
                        <span class="n">scheme_idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="n">to_read</span> <span class="o">-=</span> <span class="n">frames_in_tile</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;LivePartition.get_tiles: end of method&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_tiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tiling_scheme</span><span class="p">,</span> <span class="n">dest_dtype</span><span class="o">=</span><span class="s2">&quot;float32&quot;</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_tiles_fullframe</span><span class="p">(</span><span class="n">tiling_scheme</span><span class="p">,</span> <span class="n">dest_dtype</span><span class="p">,</span> <span class="n">roi</span><span class="p">)</span>
        <span class="k">return</span>
        <span class="c1"># # assert len(tiling_scheme) == 1</span>
        <span class="c1"># print(tiling_scheme)</span>
        <span class="c1"># pool = self._data_source.pool.get_impl(</span>
        <span class="c1">#     read_upto_frame=self._end_idx,</span>
        <span class="c1">#     chunk_size=tiling_scheme.depth,</span>
        <span class="c1"># )</span>
        <span class="c1"># to_read = int(self._end_idx - self._start_idx)</span>
        <span class="c1"># nav_slices_raw = [</span>
        <span class="c1">#     (...,) + slice_.get(sig_only=True)</span>
        <span class="c1">#     for idx, slice_ in tiling_scheme.slices</span>
        <span class="c1"># ]</span>
        <span class="c1"># with pool:</span>
        <span class="c1">#     while to_read &gt; 0:</span>
        <span class="c1">#         with pool.get_result() as res_wrapped:</span>
        <span class="c1">#             frames_in_tile = res_wrapped.stop - res_wrapped.start</span>
        <span class="c1">#             for (idx, slice_), nav_slice_raw in zip(tiling_scheme.slices, nav_slices_raw):</span>
        <span class="c1">#                 tile_shape = Shape(</span>
        <span class="c1">#                     (frames_in_tile,) + tuple(slice_.shape),</span>
        <span class="c1">#                     sig_dims=2</span>
        <span class="c1">#                 )</span>
        <span class="c1">#                 tile_slice = Slice(</span>
        <span class="c1">#                     origin=(res_wrapped.start,) + tuple(slice_.origin),</span>
        <span class="c1">#                     shape=tile_shape,</span>
        <span class="c1">#                 )</span>
        <span class="c1">#                 sliced_res = res_wrapped.buf[nav_slice_raw]</span>
        <span class="c1">#                 yield DataTile(sliced_res, tile_slice=tile_slice, scheme_idx=idx)</span>
        <span class="c1">#             to_read -= frames_in_tile</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../../../index.html">
    <img class="logo" src="../../../../_static/logo.png" alt="Logo"/>
    
  </a>
</p>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../acknowledgments.html">Acknowledgments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../reference.html">Reference</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;LiberTEM-live Authors.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.4.3</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>